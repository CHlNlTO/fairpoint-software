(19)

&

(11) EP 1 921 540 A2

(12)

EUROPEAN PATENT APPLICATION

(43) Date of publication: 14.05.2008 Bulletin 2008/20

(51) Int Cl.: G06F 3/06 (2006.01)

(21) Application number: 07253943.0

(22) Date of filing: 04.10.2007

(84) Designated Contracting States: AT BE BG CH CY CZ DE DK EE ES FI FR GB GR HU IE IS IT LI LT LU LV MC MT NL PL PT RO SE SI SK TR Designated Extension States: AL BA HR MK RS
(30) Priority: 08.11.2006 JP 2006302424
(71) Applicant: Hitachi, Ltd. Chiyoda-ku Tokyo 100-8280 (JP)

(72) Inventor: Nabekura, Yukoh c/o Hitachi, Ltd., Intellectual Porperty Chiyoda-ku, Tokyo 100-8220 (JP)
(74) Representative: Hodsdon, Stephen James Mewburn Ellis LLP York House 23 Kingsway London WC2B 6HP (GB)

(54) Storage system and controller for controlling remote copying

(57) The reconfiguration controller (110) selects for each data (112) whether or not to execute remote copying of data from the first storage device (100) to the second storage device (102). Each data sent from the host to be stored in the first storage device contains a copy policy

tag (138) that defines the policy relating to remote copying. The reconfiguration controller determines whether or not remote copying of the each data is necessary based on the copy policy tag of the each data, and selectively transmits the data requiring remote copying to the second storage device.

EP 1 921 540 A2

Printed by Jouve, 75001 PARIS (FR)

1

EP 1 921 540 A2

2

Description

[0009] The storage system following one aspect of the

present invention comprises a first storage device that

[0001] The present invention relates to a storage sys-

receives and stores at least one data set from a host,

tem in which remote copying of data can be executed

and a second storage device that receives and stores

between a plurality of storage devices, and to a controller 5 the at least one data set transmitted from of the first stor-

for controlling remote copying.

age device, and is configured such that remote copying

[0002] Copying data between a plurality of storage de-

of the data set stored in the first storage device to the

vices that are in differing sites is called "remote copying"

second storage device becomes possible. The each data

of data in this Description. Technology for remote copying

set stored in the first storage device has a copy policy

has been disclosed in Japan Patent Application Laid- 10 tag that defines the policy relating to remote copying of

open No. 2005-275537, Japan Patent Application Laid-

the data set. This storage system further comprises a

open No. 2006-39976, and Japan Patent Application

reconfiguration controller that selects whether or not to

Laid-open No. 2003-345523. According to this kind of

transmit the data set stored in the first storage device to

prior art, when a given volume within in a first storage

the second storage device based on the copy policy tag

device has been selected as the target for remote copy- 15 of the data set stored in the first storage device.

ing, all of the data within the selected volume is copied

[0010] The reconfiguration controller can be built into

from the first storage device to the second storage device.

the first storage device. Or, the reconfiguration controller

[0003] Japan Patent Application Laid-open No.

may be outside of the first storage device and second

2003-15933 discloses that, in order to reduce the amount

storage device. In the latter case, the reconfiguration con-

of data targeted for remote copying, the storage device 20 troller receives the data set that is stored in the first stor-

that receives data from the host has a table that defines

age device from the first storage device, and selects

files and directories, and whether or not to remotely copy

whether or not to transmit the data set received from the

data from the host is selected for every file or directory

first storage device to the second storage device based

by referring to that table.

on the copy policy tag of the data set received from the

[0004] The prior art disclosed in Japan Patent Appli- 25 first storage device.

cation Laid-open No. 2005-275537, Japan Patent Appli-

[0011] The copy policy tag of the each data set can

cation Laid-open No. 2006-39976, and Japan Patent Ap-

comprise an element that designates whether or not the

plication Laid-open No. 2003-345523, which copy from

data set is remote copy enabled. Then, the reconfigura-

a first storage device to a second storage device all data

tion controller may selectively transmit to the second stor-

within a volume selected as a target for copying, is es- 30 age device the data set having the copy policy tag that

tablished from the perspective of emphasizing data

designates remote copy enabled.

agreement or data guarantee between both storage de-

[0012] The copy policy tag of the data set can comprise

vices. However, data agreement or data guarantee be-

an element that designates conditions necessary for re-

tween both storage devices is not always emphasized

mote copying of the data set. Then, the reconfiguration

from a practical point of view. Actually, there are users 35 controller determines whether or not the data set fulfills

for whom the guarantee of all data is not always neces-

the conditions designated by the copy policy tag, and can

sary, and who would be satisfied with the selective re-

selectively transmit to the second storage device the data

mote copying of just specified data.

set that fulfills the conditions.

[0005] If data that does not need to be copied is none-

[0013] The conditions can include an access counter

theless updated to a volume selected as the copy target, 40 set value. In that case, the reconfiguration controller de-

then the resources and processing times of both storage

tects the access frequency of the each data set, com-

devices are wasted when copying that update data.

pares the detected access frequency with the set value

Moreover, a great number of copy data transmit process-

designated by the copy policy tag of the data set, and

ing is concentrated in the second storage device, a situ-

determines whether or not the conditions are fulfilled.

ation is produced in which the transmission processing 45 [0014] The copy policy tag of the each data set can

of copying data from the first storage device must be

comprise an element that designates whether or not the

controlled, and the processing performance of the entire

data set can be overwritten. Then, (A) when attempting

system is diminished thereby.

to transmit to the second storage device current data

[0006] An object of the present invention is to be able

having the copy policy tag designating overwrite enabled,

to select whether or not to conduct remote copying for 50 and if update data to the current data is received prior to

each data.

transmitting the current data to the second storage de-

[0007] Another object is to reduce the resource or

vice, the reconfiguration controller may transmit the up-

processing load when remotely copying with a plurality

date data to the second storage device without transmit-

of storage devices.

ting the current data to the second storage device, and

[0008] According to a general aspect of the present 55 (B) when attempting to transmit to the second storage

invention a tag is added to all data that defines a policy

device current data having the copy policy tag designat-

relating to remote copying, and data targeted for remote

ing overwrite disabled, and if update data to the current

copying is selected based on that tag.

data is received prior to transmitting the current data to

2

3

EP 1 921 540 A2

4

the second storage device, the reconfiguration controller

mit data set stored in the first storage device to the second

may transmit the update data to the second storage de-

storage device based on the copy policy tag of the data

vice after the current data is transmitted to the second

set stored in the first storage device.

storage device.

[0015] The copy policy tag of the each data set can 5 BRIEF DESCRIPTION OF THE DRAWINGS

comprise an element that designates whether or not a

transmission designation command input from a user is

[0022]

valid. Then, if the transmission designation command is

input from the user, the reconfiguration controller may

FIG. 1 is a block diagram indicating the configuration

selectively transmit to the second storage device the data 10

of a storage system related to one embodiment of

set having the copy policy tag designating that the trans-

the present invention;

mission designation command is valid.

FIG. 2 is a block diagram indicating the configuration

[0016] The first storage device may check whether or

of a storage system related to a variation;

not the reconfiguration controller is in the busy state, and

FIG. 3 is a diagram indicating an example of the

if the reconfiguration controller is in the busy state, the 15

structure of data with a tag;

first storage device can transmit, among the data sets

FIG. 4 is a diagram indicating the flow of a schematic

stored in the first storage device, the data set that has

representation of remote copying control of data with

not yet been handled by the reconfiguration controller

a tag;

directly to the second storage device without passing

FIG. 5 indicates the flow of the determination con-

through the reconfiguration controller.

20

ducted by the reconfiguration controller as to wheth-

[0017] The reconfiguration controller may check

er or not remote copying of all data is necessary;

whether or not the copy policy tags disagree between a

FIG. 6 is a diagram indicating the flow of data in the

plurality of data sets belonging to the same data group

storage system indicated in FIG. 1;

among the data sets stored in the first storage device,

FIG. 7 is a diagram indicating the flow of data in the

and if disagreements of the copy policy tags are detected, 25

storage system indicated in FIG. 2;

the same processing relating to whether or not to transmit

FIG. 8 is a diagram explaining the route of remote

to the second storage device can be applied to all of the

copying that passes through the reconfiguration con-

plurality of data sets belonging to the same data group.

troller, and the route of direct remote copying that

[0018] In addition to the configurations described

does not pass through the reconfiguration controller;

above, the storage system of aspect of the present in- 30

FIG. 9 is a diagram indicating the flow of control con-

vention may further comprise a policy tagger that attach-

ducted by the first storage device 100 in order to

es the copy policy tag to each data set stored in the first

select the two routes indicated in FIG. 8;

storage device. The policy tagger can be provided in the

FIG. 10 is a diagram indicating the configuration of

host. Alternatively, the policy tagger can be provided in

the reconfiguration controller 110 for resolving incon-

the first storage device.

35

sistencies of policy tags between data in the same

[0019] The policy tagger can attach copy policy tags

data group;

of the same content to all of the plurality of data sets

FIG. 11 is a diagram indicating a concrete example

belonging to the same data group.

of a remote copying control table; and

[0020] Following another aspect of the present inven-

FIG. 12 indicates the flow of control that the recon-

tion, in a storage system comprising a first and second 40

figuration controller conducts in order to resolve in-

storage device, a controller is provided for controlling re-

consistencies of copy policy tags.

mote copying of data sets stored in the first storage de-

vice to the second storage device. Each data set stored

[0023] Embodiments of the present invention will be

in the first storage device has a copy policy tag that de-

explained below while referring to the diagrams.

fines the policy relating to the remote copying of the data 45 [0024] FIG. 1 is the configuration of a storage system

set. Then, the controller selects whether or not to transmit

related to one embodiment of the present invention.

the data set stored in the first storage device to the second

[0025] As indicated in FIG. 1, a first storage device 100

storage device based on the copy policy tag of the data

and a second storage device 102 are set up in distinct

set stored in the first storage device.

locations, and the two mutually communicate through a

[0021] Following yet another aspect of the present in- 50 communications circuit or communications network 104.

vention, provided is a method for controlling remote cop-

A host 106 is connected to the first storage device 100.

ying of data sets stored in a first storage device to a sec-

A separate host 108 may be connected to the second

ond storage device in a storage system comprising the

storage device 102. The explanation below focuses on

first and second storage device, the method comprising

the control of remote copying when the first storage de-

the step of attaching to the each data set stored in the 55 vice 100 receives from the host 106 a write request and

first storage device a copy policy tag that defines the

data to be written, stores the received data in the first

policy relating to the remote copying of the data set, and

storage device 100, and transfers a backup copy or rep-

the step of the controller selecting whether or not to trans-

lica of the received data the second storage device 102

3

5

EP 1 921 540 A2

6

which stores the backup copy or replica of the data. The

the reconfiguration controller 110 does not transmit that

explanation of the control when the host 106 reads data

data 112 to the second storage device 102 (specifically,

from the first storage device 102 will be omitted.

does not execute remote copying). Consequently, not all

[0026] When all of the data that the host 106 requests

of the data written in the first storage device 100, but only

to be written to the first storage device 100 is transmitted 5 the part of the data selected by the reconfiguration con-

to the second storage device 102, although all of the data

troller 110 is remotely copied to the second storage de-

can be guaranteed, if the processing capacity of the sec-

vice 102. Here, as a method for reconfiguration controller

ond storage device 102 is particularly low, the processing

110 to control the processing order of a large quantity of

of the first storage device 100 will be affected in that the

data 112 received from the host 106, for example, a meth-

first storage device 100 will have to wait. In practical 10 od such as a wrap around system can be adopted in

terms, the user does not always need all of the data to

which old data is processed first based on time stamps

be guaranteed. In the storage system related to this em-

following the ascending order of respectively time

bodiment, tags that define the policy relating to remote

stamped data. The operation of the data 112 being re-

copying are attached to the data, and data targeted for

motely copied from the first storage device 100 to the

remote copying are selected based on these tags.

15 second storage device 102, and the operation of storing

[0027] The host 106 has a policy tagger 107, and the

that data 112 in a storage region of the first storage device

policy tagger 107 can be implemented by a computer

100 may be executed asynchronously, for example, ex-

program, a routed logical circuit or a combination of

ecuting the former operation after the latter operation. By

these. When data to be written to the first storage device

remotely copying only the data sorted and selected by

100 is generated in the host 106, the policy tagger 107 20 the reconfiguration controller 110, the resources of the

attaches to the data a copy policy tag that defines the

second storage device 102 are economized, and the

detailed conditions or policy regarding whether or not to

processing load is reduced. This reduces the possibility

remotely copy that data. Consequently, the data sent in

of the processing capacity of the second storage device

conjunction with the write request from the host 106 to

102 affecting the first storage device 100 when backing

the first storage device is data 112 with a tag. The content 25 up or mirroring data.

of the copy policy tag attached to the data 112 by the

[0029] As indicated by the dotted line in FIG. 1, a policy

policy tagger 107 can be set by the system user. A con-

tagger 109 may be set up in the first storage device 100.

crete example of the content of a copy policy tag will be

The policy tagger 109 in the first storage device 100 can

described later.

attach copy policy tags to the data received from the host

[0028] When the write request and the data 112 to be 30 106. For example, if copy policy tags are not attached to

written are received from the host 106, the first storage

the data received from the host 106, the policy tagger

device 100 stores that data 112 at the address designat-

109 attaches copy policy tags to that data. Or, if the copy

ed by the write request within a storage region in the first

policy tags attached to the data 112 received from the

storage device 100. The first storage device 100 has the

host 106 are not suitable, the policy tagger 109 can cor-

reconfiguration controller 110, and the reconfiguration 35 rect the unsuitable copy policy tags of that data 112 to

controller 110 can be implemented by a computer pro-

proper ones.

gram, a routing logical circuit or a combination of these.

[0030] FIG. 2 is a variant of the storage system indi-

When a request is made from the host 106 to write the

cated in FIG. 1.

data 112 to the first storage device 100, the reconfigura-

[0031] As indicated in FIG. 2, the reconfiguration con-

tion controller 110 controls whether or not to remotely 40 troller 110 is set up as an independent device outside of

copy the data 112 from the first storage device 100 to

the first and second storage devices 100 and 102. This

the second storage device 102 by following the copy pol-

independent reconfiguration controller 110 can commu-

icy tags attached to that data 112. By controlling the re-

nicate with the first and second storage devices 100 and

mote copying that the reconfiguration controller 110 ex-

102 through a communications line or the communica-

ecutes, a database is reconfigured within the second 45 tions network 104. When receiving from the host 106 the

storage device 102 that has a form different than the da-

write request together with data 112 to be written, the

tabase configured in the first storage device 100. Stated

first storage device 100 stores that data 112 in a storage

more concretely, the reconfiguration controller 110 de-

region within the first storage device 100, generates data

termines whether or not it is necessary to execute remote

116, which is a duplicate data 112, and transmits the data

copying of the data 112 based on the copy policy tag 50 116 to the reconfiguration controller 110. The reconfigu-

attached to the data 112, for which the host 106 has made

ration controller 110 controls whether or not to execute

a write request. If determined that remote copying of a

remote copying of the data 116 from the first storage

given data 112 is necessary, the reconfiguration control-

device 100 to the second storage device 102 in the same

ler 110 generates a duplicate data 116 of that data 112,

manner as the reconfiguration controller 110 indicated in

and transmits that duplicate together with the write re- 55 FIG. 1.

quest to the second storage device 102 (specifically, ex-

[0032] When the reconfiguration controller 110 is built

ecutes remote copying). On the other hand, if determined

into the first storage device 100 as indicated in FIG. 1,

that remote copying of a given data 112 is not necessary,

there is the advantage that the reconfiguration controller

4

7

EP 1 921 540 A2

8

110 can utilize the first storage device 100 resources. On

in principle execute remote copying of that data.

the other hand, if the reconfiguration controller 110 is an

[0041] Key 2 designates whether or not overwriting is

independent device arranged outside of the first and sec-

enabled. If the key 2 attached to given data designates

ond storage devices 100 and 102 as shown in FIG. 2,

overwrite enabled, then when attempting to execute re-

there are the advantages that the processing capacity of 5 mote copying of that data, if the reconfiguration controller

the reconfiguration controller 110 can be easily height-

110 receives update data relating to that data prior to

ened without affecting the processing capacities of the

transmitting that data to the second storage device 102,

first and second storage devices 100 and 102, and that

the current data is overwritten with that update data, and

a plurality of storage devices can jointly use one recon-

then the updated data is transmitted to the second stor-

figuration controller 110.

10 age device 102 (specifically, only the updated data, and

[0033] As another variation not indicated in the dia-

not the current data, is transmitted to the second storage

grams, the reconfiguration controller 110 may be set up

device 102). On the other hand, if the key 2 designates

inside the second storage device 102.

overwrite disabled, the reconfiguration controller 110

[0034] FIG. 3 indicates an example of the structure of

does not transmit the update data to the second storage

data with tags.

15 device 102 until after the current data has been transmit-

[0035] As indicated in FIG. 3, the data 112 with tags

ted to the second storage device 102.

contains the actual data 150 that represents the essential

[0042] Keys 3 and 4 designate conditions for determin-

content of that data, and additional information that is

ing if remote copying is necessary. In this example, ac-

added to this actual data 150; and this additional infor-

cess frequency is adopted as that condition, and keys 3

mation contains the time stamp 132, data length 134, 20 and 4 designate the access frequency elements of the

group attribute 136, and copy policy tag 138. The time

observation period and the access counter set value. If

stamp 132 indicates the date and time that the actual

the key 1 attached to given data designates remote cop-

data 150 was generated. The data length 134 indicates

ying enabled, and if the keys 3 and 4 designate a given

the length or amount of data of the actual data 150. The

observation period and a given access counter set value,

group attribute 136 indicates the identification of the data 25 the reconfiguration controller 110 ascertains the data ac-

group to which the actual data 150 belongs, as well as

cess frequency that has been executed between the

the identification of the actual data 150 within that data

nearest past (or nearest future) observation period based

group. The copy policy tags 138 have numerous differing

on an access log within the first storage device 100 or

degrees of priority, for example, the five items (called

based on similar information. If the ascertained access

"keys" hereinafter) 140 to 148.

30 frequency is the designated access counter set value or

[0036] The above data group is a collection of a plu-

greater, that data is considered important data, and

rality of actual data 150 that has significance as a whole

therefore it is determined that remote copying of that data

from the perspective of the data use objective. A typical

is necessary. On the other hand, if the ascertained ac-

example of a data group is a file. Preferably, the same

cess frequency is less than the designated access coun-

copy policy tag is attached to all data belonging to the 35 ter set value, that data is not considered important data,

same data group. For that reason, the policy tagger 107

and therefore it is determined that remote copying of that

or 109 indicated in FIG. 1 or 2 receive copy policy settings

data is not necessary. If the key 1 attached to given data

from the user for every data group (for example, for every

designates remote copying enabled, and if the keys 3

file), and can automatically attach to all of the data 150

and 4 do not designate a significant observation period

belonging to the same data group (for example, the same 40 or significant access counter set value, if no significant

file) the same copy policy tag 138 relating to the copy

content has been set in the keys 3 and 4, the reconfigu-

policy set up by the user for that data group.

ration controller 110 determines that remote copying of

[0037] FIG. 4 indicates the flow of a schematic repre-

the data is necessary.

sentation of remote copying control of data with a tag.

[0043] The key 5 designates whether or not a trans-

[0038] In FIG. 4, steps S1 to S8 are conducted by the 45 mission designation command that the user manually in-

host 106. Here, the steps S3 to S7 for attaching copy

puts is valid. If the key 5 attached to given data designates

policy tags may be conducted by the first storage device

that the transmission designation command is valid, and

100. Steps S10 to S13 are conducted by the reconfigu-

if the user has issued a transmission designation com-

ration controller 110.

mand, the reconfiguration controller 110 determines that

[0039] At step S1, the host 106 generates data to be 50 remote copying of that data is necessary no matter what

written by the first storage device 100. At step S2, a time

the results were when determining the necessity of re-

stamp is attached to that data. At steps S3 to S6, copy

mote copying based on the settings of keys 1 to 4. If other

policy tags, specifically, keys 1 to 5 are attached. The

than this, the reconfiguration controller 110 operates by

roles of the keys 1 to 5 are as follows.

following the results of the remote copying necessity de-

[0040] Key 1 designates whether or not remote copy- 55 termination based on the settings of keys 1 to 4.

ing of that data is enabled. If the key 1 attached to given

[0044] In step S8 of FIG. 4, the data with the added

data designates that remote copying of that data is dis-

time stamp and keys 1 to 5 is transmitted from the host

abled, then the reconfiguration controller 110 does not

106, and at step S9 that is data is received by the first

5

9

EP 1 921 540 A2

10

storage device 100.

current data prior to transmitting the current data to the

[0045] At step S10, the reconfiguration controller 110

second storage device 102, at step S24 the reconfigura-

sets up the specified determination logic for determining

tion controller 110 does not overwrite the current data

whether or not remote copying is necessary, and at step

with the update data, and does not transmit the update

S11 determines the necessity of the remote copying of 5 data to the second storage device 102 until the current

that data by applying to that determination logic the keys

data has been transmitted to the second storage device

1 to 5 attached to the received data. If determined that

102.

remote copying of that data is necessary, at step S12 the

[0050] Subsequently, at step S25 the set values of

reconfiguration controller 110 transmits that data (that

keys 3 and 4 are referenced. If a significant observation

duplicate data) to the second storage device 102, and 10 period and significant access counter set value have

has that data stored in a storage region within the second

been set in key 3 and key 4, at step S26 the reconfigu-

storage device 102. That is, if determined that remote

ration controller 110 ascertains the data access frequen-

copying of that data is necessary, the reconfiguration

cy that has been executed between the nearest past (or

controller 110 transmits the write request and the dupli-

nearest future) observation period based on an access

cate data of that data to the second storage device 102, 15 log within the first storage device 100 or based on similar

and then the second storage device 102 stores that trans-

information, and checks whether that ascertained access

mitted data at the address within the storage region in

frequency is the designated access counter set value or

the second storage device 102 designated by the write

greater. If the results are that the ascertained access

request. On the other hand, if determined that remote

frequency is the designated access counter set value or

copying of that data is not necessary, at step S13 the 20 greater, at step S27 it is determined that remote copying

reconfiguration controller 110 does not transmit that data

of that data is necessary. On the other hand, if the as-

to the second storage device 102.

certained access frequency is less than the designated

[0046] FIG. 5 indicates the flow of the reconfiguration

access counter set value, it is determined that remote

controller 110 to determine whether or not remote copy-

copying of that data is not necessary. Moreover, if no

ing of all data is necessary.

25 significant observation period and significant access

[0047] In this embodiment, the determination process-

counter set value are set in the keys 3 and 4, then it is

ing in FIG. 5 is conducted for every minimum unit

determined at step S27 that remote copying of the data

("record" hereinafter) of data transmitted for remote cop-

is necessary.

ying between the first storage device 100 and the second

[0051] Independently from the determinations based

storage device 102. The concrete size of this record can 30 on the keys 1 to 4 above, a determination is also executed

vary depending on the concrete specifications of the stor-

based on the key 5. Specifically, at step S29 it is deter-

age devices 100 and 102. One typical example of a

mined whether or not the transmission designation com-

record is a track of a recording disk device that provides

mand is valid by referring to the key 5. If determined that

a storage region in the storage devices 100 and 102, but

the transmission designation command is valid, at step

this is not always necessary, and, for example, a record 35 S30 it is determined if a transmission designation com-

may be a logical block or some other unit. In any event,

mand has been issued, and if the results are YES, then

a record is a data unit smaller than that of a data group

it is determined at step S27 that remote copying of that

such as a file.

data is necessary.

[0048] The determination processing indicated in FIG.

[0052] FIG. 6 indicates the flow of data in the storage

5 is executed for every record of this kind. In this deter- 40 system indicated in FIG. 1.

mination processing, the key 1 has the highest priority,

[0053] Assume that a plurality of data No. 1, No. 2 and

the key 2 has the second priority, and the keys 3 and 4

No. 3 are sent sequentially together with a write request

have the third priority. These keys are processed in this

from the host 106 to first storage device 100. The data

priority order. Specifically, at step S21, key 1, which was

No. 1, No. 2 and No. 3 that are received by the first storage

attached to this record data is referenced, and it is de- 45 device 100 are memorized in the cache region 160 in the

termined whether or not that data is remote copy enabled.

first storage device 100. The reconfiguration controller

[0049] If determined at step S21 that that data is re-

110 in the first storage device 100 checks the copy policy

mote copy enabled, key 2 is referenced at step S22, and

tags of the data No. 1, No. 2 and No. 3 in the cache region

it is determined whether or not that data can be overwrit-

160 sequentially in order of the earliest time stamp, and

ten. Here, if determined to be overwrite enabled, when 50 determines whether or not remote copying is necessary

update data to the current data is received prior to trans-

for each data No. 1, No. 2 and No. 3 based on the re-

mitting that data to the second storage device 102, at

spective copy policy tags.

step S23 the reconfiguration controller 110 overwrites

[0054] If as a result of this determination it is deter-

the current data with that update data, and then transmits

mined that the data No. 1 and No. 3 require remote cop-

that updated data to the second storage device 102, and 55 ying, duplicates of the data No. 1 and No. 3 respectively

omits transmission of the current data to the second stor-

are prepared on the cache region 160, and that duplicate

age device 102. On the other hand, if determined to be

data No. 1 and No. 3 are written respectively to the ad-

overwrite disabled, when receiving update data to the

dresses 162 and 166 in the storage region in the first

6

11

EP 1 921 540 A2

12

storage device 100 that was designated by the write re-

region 180. On the other hand, if determined that remote

quest, and further, these data together with a write re-

copying of the data No. 2 is unnecessary, the reconfig-

quest are transmitted by the reconfiguration controller

uration controller 110 does not transmit the data No. 2

110 to the second storage device 102. After completing

to the second storage device 102. The data No. 2 in the

the respective writing of the data No. 1 and No. 3 in the 5 cache region 180 is deleted from the cache region 180

cache region 160 to the storage region in the first storage

immediately after it is determined that remote copying is

device 100, and after completing the transmission to the

unnecessary. In the second storage device 102 the data

second storage device 102, the data is deleted from the

No. 1 and No. 3 that were transmitted together with a

cache region 160. On the other hand, when determined

write request from the reconfiguration controller 110 are

that the remote copying is unnecessary, the data No. 2 10 memorized in the cache region 170, and are subsequent-

is written to the address 164 in the storage region in the

ly written to the addresses 172 and 174 in the storage

first storage device 100 that was designated by the write

region designated by the write request.

request, but is not transmitted to the second storage de-

[0059] As described above, only the data that has been

vice 102. In the second storage device 102, the data No.

determined by the reconfiguration controller 110 to re-

1 and No. 3 that were transmitted together with a write 15 quire remote copying is selected and remotely copied.

request from the reconfiguration controller 110 are mem-

Nonetheless, in the present embodiment, in addition to

orized in the cache region 170, and are subsequently

the method of remote copying by a route passing through

written to the addresses 172 and 174 in the storage re-

the reconfiguration controller 110 as indicated above, it

gion designated by the write request. After the data No.

is also possible to utilize the method of remotely copying

2 in the cache region 160 has been written to the storage 20 by transmitting data from the first storage device 100 to

region in the first storage device 100, that data is deleted

the second storage device 102 by a direct route that does

from the cache region 160.

not pass through the reconfiguration controller 110. The

[0055] FIG. 7 indicates the flow of data in the storage

latter route, for example, can be utilized as a substitute

system indicated in FIG. 2.

for the former route when the reconfiguration controller

[0056] Here, assume that a plurality of data No. 1, No. 25 110 has a high load or is busy for some other reason,

2 and No. 3 together with a write request have been suc-

and a processing delay has been generated in the recon-

cessively transmitted from the host 106 to the first storage

figuration controller 110.

device 100. In the same manner as with FIG. 6, the data

[0060] FIG. 8 explains the route of remote copying that

No. 1, No. 2 and No. 3 are memorized in cache region

passes through the reconfiguration controller 110, and

160 in the first storage device 100. Duplicates are re- 30 the route of direct remote copying that does not pass

spectively prepared for the data No. 1, No. 2 and No. 3

through the reconfiguration controller 110.

in the cache region 160, and that duplicated data No. 1,

[0061] In FIG. 8, assume, after having successively

No. 2 and No. 3 are respectively written at the addresses

sent to the reconfiguration controller 110 the data No. 1,

162, 164 and 166 in the storage region in the first storage

No. 2 and No. 3 in the routes indicated by the arrows

device 100 designated by the write request, and are fur- 35 200, that the data No. 1 is currently being processed at

ther transmitted to the reconfiguration controller 110. Af-

the reconfiguration controller 110, that the data No. 2 and

ter completing the respective writing of the data No. 1,

No. 3 are awaiting subsequent processing, and that a

No. 2 and No. 3 in the cache region 160 to the storage

busy state has occurred in which it is difficult to receive

region in the first storage device 100, and after complet-

the data No. 4 that comes even later. In this case, the

ing the transmission to the reconfiguration controller 110, 40 first storage device 100 can execute a remote copy by

the data is deleted from the cache region 160.

transmitting the subsequent data No. 4, which has not

[0057] At the reconfiguration controller 110, the data

been transmitted to the reconfiguration controller 110, to

No. 1, No. 2 and No. 3 that were transmitted from the

the second storage device 102 by a direct route that does

first storage device 100 are memorized in the cache re-

not pass through the reconfiguration controller 110 as

gion 180 in the reconfiguration controller 110. The recon- 45 indicated by the arrow 202. Further increase of the load

figuration controller 110 checks the copy policy tags of

on the reconfiguration controller 110 can thereby be

the data No. 1, No. 2 and No. 3 in the cache region 180

avoided. The same data as the data No. 1, No. 2 and No.

sequentially in order of the earliest time stamp, and de-

3 already transmitted to the reconfiguration controller 110

termines whether or not remote copying is necessary for

is not transmitted by the direct route 202.

each data No. 1, No. 2 and No. 3 based on the respective 50 [0062] FIG. 9 indicates the flow of control conducted

copy policy tags.

by the first storage device 100 in order to select the two

[0058] If as a result it is determined that remote copying

transmission routes described above.

of data No. 1 and No. 3 is necessary, the reconfiguration

[0063] In FIG. 9, at step S41, write request data is re-

controller 110 transmits the data No. 1 and No. 3 together

ceived from host 106 by the first storage device 100. At

with a write request to the second storage device 102. 55 step S42, the first storage device 100 communicates with

After completing the respective transmissions of the data

the reconfiguration controller 110 to check the status of

No. 1 and No. 3 in the cache region 180 to the second

the reconfiguration controller 110. If as a result of that

storage device 102, the data is deleted from the cache

check, the status of the reconfiguration controller 110 is

7

13

EP 1 921 540 A2

14

normal ("NO" at step S43), at step S44 the first storage

tag should be attached to both the data No. 1 and No. 2

device 100 transmits the reception data to the reconfig-

of the differing records belonging to a given same data

uration controller 110.

group No. 1, and the same copy policy tag should be

[0064] On the other hand, if as a result of the check at

attached to both the data No. 3 and No. 4 of differing

step S42 the reconfiguration controller 110 is in the busy 5 records belonging to a separate same data group No. 2.

state ("YES" at step S43), at step S45 the first storage

If, for example, the copy policy tags of the data No. 1 and

device 100 determines whether or not remote copying of

No. 2 differ, the reconfiguration controller 110 forcibly

that reception data is necessary. This determination uses

controls both the data No. 1 and No. 2 to have the same

the same logic as the determination logic that the recon-

necessity or not of remote copying (typically, remote cop-

figuration controller 110 executes, and can be executed 10 ying is made unnecessary). In this regard, FIG. 10 indi-

based on the copy policy tags attached to the reception

cates a system in which the reconfiguration controller

data. If the result of that determination determines that

110 is built into the first storage device 100, but the con-

remote copying is necessary, ("YES" at step S45), at step

figuration and operation of the reconfiguration controller

S46 the first storage device 100 transmits the reception

110 for resolving the aforementioned problem are the

data to the second storage device 102 by the direct route 15 same even in a system with reconfiguration controller

202. On the other hand, if the determination results at

110 outside the first storage device 100 as indicated in

step S45 determined that remote copying is unneces-

FIG. 2.

sary, that reception data is not transmitted. By repeating

[0069] FIG. 11 indicates a concrete example of a re-

the control in FIG. 9, the route passing through the recon-

mote copying control table.

figuration controller 110 can be selected again after the 20 [0070] In the example of FIG. 11, the remote copy con-

reconfiguration controller 110 has returned from the busy

trol items of data No. 1, No. 2, No. 3 and No. 4 of a plurality

state to the normal.

of records received from the host 106 are registered in

[0065] In this regard, the step S45 described above

the remote copy control table 230. The remote copy con-

may be omitted. Specifically, if the reconfiguration con-

trol items of every record registered in the remote copy

troller 110 is in the busy state ("YES" at step S43), the 25 control table 230 comprise, for example, a record iden-

control may advance to the step S46.

tification (for example, track identification), time stamp,

[0066] As already described, the policy tagger 107 or

data identification, data group identification, and copy

109 indicated in FIG. 1 or FIG. 2 can automatically attach

policy tag (specifically, key 1, key 2, key 3, key 4, and

to all the data belonging to the same data group (for ex-

key 5). Further, the determination results of whether or

ample, the same file) the same policy tag reflecting the 30 not remote copying is necessary for the data of every

copy policy that the user sets for that data group. How-

record is also registered in the remote copy control table

ever, there is still a risk of problems occurring by attaching

230. The reconfiguration controller 110 refers to the re-

different copy policy tags to differing data belonging to

mote copy control table 230 like the example indicated

the same data group (for example, the same file). To

in FIG. 11, and compares the copy policy tags (key 1,

resolve this problem, in this embodiment, in the final de- 35 key 2, key 3, key 4, and key 5) between the differing

termination of whether or not remote copying of data is

records (data) having the same data group identification.

necessary, the reconfiguration controller 110 has a logic

If a mismatch is found in the copy policy tags as a result

that poses different determination results than the deter-

of this comparison, irrespective of the content of the copy

mination results based on the copy policy tags attached

policy tags, the determination results of the necessity or

to the data as described above.

40 not for remote copying of these data are forcibly set to

[0067] FIG. 10 indicates the configuration of the recon-

be the same, for example, "remote copying unneces-

figuration controller 110 for resolving inconsistencies of

sary". In the example indicated in FIG. 11, there is a mis-

policy tags between data in the same data group.

match of copy policy tags (mismatch of key 1 and key 3)

[0068] As indicated in FIG. 10, the reconfiguration con-

between differing data No. 1 and No. 2 belonging to the

troller 110 has a remote copy control table 230, and reg- 45 same data group No. 1, and therefore, the determination

istered in this remote copy control table 230 are a plurality

results of the necessity or not of remote copying of data

of information items (called "remote copy control items"

No. 1 and No. 2 is forcibly set to "remote copying unnec-

hereinafter) necessary for the remote copy control of data

essary". On the other hand, the copy policy tags agree

for every record (for example, track). The reconfiguration

between differing data No. 3 and No. 4 belonging to sep-

controller 110 refers to the remote copy control table 230 50 arate same data group No. 2, and therefore, the deter-

and searches for inconsistencies in the copy policy tags

mination results of whether or not remote copying of data

between records in the same data group (for example,

No. 3 and No. 4 is necessary are set to the results de-

in the same file), and if inconsistencies in copy policy

termined based on that same copy policy tag.

tags are found, irrespective of the contents of the copy

[0071] FIG. 12 indicates the flow of control that the

policy tags of these data, the necessity or not for remote 55 reconfiguration controller 110 conducts in order to re-

copying of these records is forcibly controlled to be the

solve inconsistencies of copy policy tags.

same (typically, remote copying is made unnecessary).

[0072] In FIG. 12, at step S51, every time data to be

In the example indicated in FIG. 10, the same copy policy

written is received, the reconfiguration controller 110 reg-

8

15

EP 1 921 540 A2

16

isters the remote copy control items of the received data

first storage device.

in the remote copy control table 230. At step S52, the

reconfiguration controller 110 refers to the remote copy

3. The storage system according to claim 1,

control table 230, and searches for mismatches by com-

wherein the reconfiguration controller is located out-

paring the copy policy tags between the data belonging 5

side of the first storage device and the second stor-

to the same data group. If no mismatches are found in

age device, receives each data set stored in the first

the results ("YES" at step S53), at step S54 the recon-

storage device from the first storage device, and se-

figuration controller 110 selects processing that transmits

lects whether or not to transmit the data set received

or does not transmit to the second storage device 102

from the first storage device to the second storage

the data registered in the remote copy control table 230 10

device based on the copy policy tag of the data set

following the determination results of whether or not re-

received from the first storage device.

mote copying is necessary based on the copy policy tags

thereof.

4. The storage system according to any one of claims

[0073] If copy policy tag mismatches were found be-

1 to 3, wherein the copy policy tag of the each data

tween data belonging to the same data group ("NO" at 15

set comprises an element that designates whether

step S53), at step S55, the reconfiguration controller 110

or not remote copying of the data set is enabled, and

uses the same determination result for the necessity or

the reconfiguration controller selectively transmits to

not of remote copying for all of that data group registered

the second storage device the data set having the

in the remote copy control table 230. "Remote copying

copy policy tag that designates remote copy ena-

unnecessary", for example, can be adopted as this same 20

bled.

determination result, but "remote copying necessary"

may be adopted instead, or, determination results based

5. The storage system according to any one of claims

on the copy policy tags of the old time stamped data in

1 to 4, wherein the copy policy tag of the each data

the data belonging to that data group in the remote copy

set comprises an element that designates conditions

control table 230 may be adopted. At step S56, the recon- 25

for requiring remote copying of the data set, and the

figuration controller 110 reports to the host 106 that there

reconfiguration controller determines whether or not

were copy policy tag mismatches in that data group.

the data set fulfills the conditions designated by the

[0074] Embodiments of the present invention were ex-

copy policy tag, and selectively transmits to the sec-

plained above, but these embodiments were nothing

ond storage device the data set that fulfills the con-

more than examples to explain the present invention. The 30

ditions.

present invention can be implemented in a variety of

forms other than the embodiments described above as

6. The storage system according to claim 5,

long as they do not deviate from the scope thereof.

wherein the conditions comprise an access counter

set value, and the reconfiguration controller detects

35

the access frequency of the each data set, and de-

Claims

termines whether or not the conditions are fulfilled

by comparing the detected access frequency with

1. A storage system which comprises a first storage

the set value designated by the copy policy tag of

device that receives and stores at least one data set

the data set.

from a host, and a second storage device that re- 40

ceives and stores the at least one data set transmit-

7. The storage system according to any one of claims

ted from the first storage device, and in which remote

1 to 6, wherein the copy policy tag of the each data

copying of the data set stored in the first storage

set comprises an element that designates whether

device to the second storage device can be execut-

or not the data set can be overwritten, and

ed,

45

wherein

(A) when attempting to transmit to the second

each data set stored in the first storage device has

storage device current data having the copy pol-

a copy policy tag that defines a policy relating to the

icy tag designating overwrite enabled, and if up-

remote copying of the data set,

date data to the current data is received prior to

the storage system further comprising a reconfigu- 50

transmitting the current data to the second stor-

ration controller that selects whether or not to trans-

age device, the reconfiguration controller trans-

mit the data set stored in the first storage device to

mits the update data to the second storage de-

the second storage device based on the copy policy

vice without transmitting the current data to the

tag of the each data set stored in the first storage

second storage device, and

device.

55

(B) when attempting to transmit to the second

storage device current data having the copy pol-

2. The storage system according to claim 1,

icy tag designating overwrite disabled, and if up-

wherein the reconfiguration controller is built into the

date data to the current data is received prior to

9

17

EP 1 921 540 A2

18

transmitting the current data to the second stor-

the second storage device, wherein

age device, the reconfiguration controller trans-

each data set stored in the first storage device has

mits the update data to the second storage de-

a copy policy tag that defines the policy relating to

vice after the current data is transmitted to the

the remote copying of the data set, and

second storage device.

5

the controller selects whether or not to transmit the

data set stored in the first storage device to the sec-

8. The storage system according to any one of claims

ond storage device based on the copy policy tag of

1 to 7, wherein the copy policy tag of the each data

the data set stored in the first storage device.

set comprises an element designating whether or

not a transmission designation command input from 10 16. A method for controlling remote copying of data sets

a user is valid, and if the transmission designation

stored in a first storage device to a second storage

command from the user is input, the reconfiguration

device in a storage system comprising the first and

controller selectively transmits to the second storage

second storage devices, the method comprising the

device the data set having the copy policy tag that

steps of:

designates that the transmission designation com- 15

mand is valid.

attaching to the each data set stored in the first

storage device a copy policy tag that defines the

9. The storage system according to any one of claims

policy relating to remote copying of the data set,

1 to 8, wherein the first storage device checks wheth-

and

er or not the reconfiguration controller is in the busy 20

the controller selecting whether or not to transmit

state, and if the reconfiguration controller is in the

the data set stored in the first storage device to

busy state, the first storage device transmits, among

the second storage device based on the copy

the data sets stored in the first storage device, the

policy tag of the data set stored in the first stor-

data set not yet handled by the reconfiguration con-

age device.

troller directly to the second storage device without 25

passing through the reconfiguration controller.

10. The storage system according to any one of claims 1 to 9, wherein the reconfiguration controller checks whether or not there are mismatches of the copy 30 policy tags between a plurality of data sets belonging to the same data group within the data sets stored in the first storage device, and if mismatches of the copy policy tags are detected, the same processing relating to whether or not to transmit to the second 35 storage device is applied to all of the plurality of data sets belonging to the same data group.

11. The storage system according to any one of claims 1 to 10, further comprising a policy tagger that at- 40 taches the copy policy tag to the each data set stored in the first storage device.

12. The storage system according to claim 11, wherein the policy tagger is provided in the host. 45

13. The storage system according to claim 11, wherein the policy tagger is provided in the first storage device.
50
14. The storage system according to any one of claims 11 to 13, wherein the policy tagger attaches the copy policy tag of the same content to all of the plurality of data sets belonging to the same data group.
55
15. A controller in a storage system comprising first and second storage devices, which controls remote copying of data sets stored in the first storage device to

10

EP 1 921 540 A2 11

EP 1 921 540 A2 12

EP 1 921 540 A2 13

EP 1 921 540 A2 14

EP 1 921 540 A2 15

EP 1 921 540 A2 16

EP 1 921 540 A2 17

EP 1 921 540 A2 18

EP 1 921 540 A2 19

EP 1 921 540 A2 20

EP 1 921 540 A2 21

EP 1 921 540 A2
REFERENCES CITED IN THE DESCRIPTION
This list of references cited by the applicant is for the reader's convenience only. It does not form part of the European patent document. Even though great care has been taken in compiling the references, errors or omissions cannot be excluded and the EPO disclaims all liability in this regard.

Patent documents cited in the description
 JP 2005275537 A [0002] [0004]  JP 2006039976 A [0002] [0004]

 JP 2003345523 A [0002] [0004]  JP 2003015933 A [0003]

22

